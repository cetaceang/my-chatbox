{% extends "base.html" %}
{% load static %}
<!-- 版本号：1.0.1 -->

{% block extra_head %}
<link rel="stylesheet" href="{% static 'chat/css/chat_page.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>对话列表</span>
                    <a href="{% url 'chat-main' %}?no_new=0" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> 新对话
                    </a>
                </div>
                <div class="card-body" id="conversation-list">
                    {% include 'chat/conversation_list.html' %}
                </div>
            </div>
        </div>

        <!-- 主聊天区 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>当前对话：{{ conversation.title }}</span>
                    <select id="model-select" class="form-select form-select-sm" style="width: auto">
                        {% for model in models %}
                        <option value="{{ model.id }}" {% if conversation.selected_model.id == model.id %}selected{% endif %}>{{ model.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="card-body chat-container">
                    <div id="message-container" style="height: 60vh; overflow-y: auto">
                        {% include 'chat/message_list.html' %}
                    </div>
                    
                    <div class="input-group mt-3">
                        <textarea id="message-input" class="form-control" rows="3" 
                                  placeholder="输入消息..." style="resize: none"></textarea>
                        <button id="send-button" class="btn btn-primary">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Define global variables needed by external scripts -->
<script>
    // Set the global conversationId from Django template context
    // This needs to be defined BEFORE chat_page.js runs.
    window.conversationId = {% if conversation %}"{{ conversation.id }}"{% else %}null{% endif %};
    // Initialize tempIdMap globally so it's available to all modules
    window.tempIdMap = {};
</script>

<!-- Load External JavaScript Modules -->
<!-- utils.js contains shared functions and needs to be loaded first -->
<script src="{% static 'chat/js/utils.js' %}"></script>
<!-- message_renderer.js depends on utils.js (escapeHtml) -->
<script src="{% static 'chat/js/message_renderer.js' %}"></script>
<!-- websocket_handler.js depends on utils.js and message_renderer.js -->
<script src="{% static 'chat/js/websocket_handler.js' %}"></script>
<!-- api_handler.js depends on utils.js and message_renderer.js -->
<script src="{% static 'chat/js/api_handler.js' %}"></script>
<!-- chat_page.js orchestrates everything and should be loaded last -->
<script src="{% static 'chat/js/chat_page.js' %}"></script>

{% endblock %}
