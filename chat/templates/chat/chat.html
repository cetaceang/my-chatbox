{% extends "base.html" %}
{% load static %}
<!-- 版本号：1.0.1 -->

<!-- 添加CSS样式 -->
<style>
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .btn-processing {
        opacity: 0.7;
        pointer-events: none;
    }
</style>

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>对话列表</span>
                    <a href="{% url 'chat-main' %}?no_new=0" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> 新对话
                    </a>
                </div>
                <div class="card-body" id="conversation-list">
                    {% include 'chat/conversation_list.html' %}
                </div>
            </div>
        </div>

        <!-- 主聊天区 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>当前对话：{{ conversation.title }}</span>
                    <select id="model-select" class="form-select form-select-sm" style="width: auto">
                        {% for model in models %}
                        <option value="{{ model.id }}" {% if conversation.selected_model.id == model.id %}selected{% endif %}>{{ model.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="card-body chat-container">
                    <div id="message-container" style="height: 60vh; overflow-y: auto">
                        {% include 'chat/message_list.html' %}
                    </div>
                    
                    <div class="input-group mt-3">
                        <textarea id="message-input" class="form-control" rows="3" 
                                  placeholder="输入消息..." style="resize: none"></textarea>
                        <button id="send-button" class="btn btn-primary">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket连接 -->
<script>
// 存储会话ID和WebSocket连接
let conversationId = null;
let chatSocket = null;
// 存储临时ID到实际ID的映射
let tempIdMap = {};

// 辅助函数：获取消息的真实ID（处理临时ID）
function getRealMessageId(tempId) {
    // 如果不是临时ID，直接返回
    if (!tempId || !tempId.startsWith('temp-')) {
        return tempId;
    }
    
    // 尝试从映射表中获取
    if (tempIdMap[tempId]) {
        console.log(`从映射表中获取真实ID: ${tempId} -> ${tempIdMap[tempId]}`);
        return tempIdMap[tempId];
    }
    
    // 尝试从DOM中获取
    const messageContainer = document.querySelector('#message-container');
    if (!messageContainer) return null;
    
    const messages = messageContainer.querySelectorAll('.alert');
    for (let i = 0; i < messages.length; i++) {
        const msgDiv = messages[i];
        // 检查data-temp-id属性
        if (msgDiv.getAttribute('data-temp-id') === tempId) {
            const realId = msgDiv.getAttribute('data-message-id');
            if (realId && !realId.startsWith('temp-')) {
                // 保存到映射表中
                tempIdMap[tempId] = realId;
                console.log(`从DOM中获取真实ID: ${tempId} -> ${realId}`);
                return realId;
            }
        }
        
        // 如果消息ID本身就是临时ID
        if (msgDiv.getAttribute('data-message-id') === tempId) {
            const realId = msgDiv.getAttribute('data-real-id');
            if (realId && !realId.startsWith('temp-')) {
                // 保存到映射表中
                tempIdMap[tempId] = realId;
                console.log(`从DOM中获取真实ID: ${tempId} -> ${realId}`);
                return realId;
            }
        }
    }
    
    // 检查是否有任何消息正在等待ID更新
    for (let i = 0; i < messages.length; i++) {
        const msgDiv = messages[i];
        if (msgDiv.getAttribute('data-waiting-id') === '1') {
            console.warn(`发现消息正在等待ID更新，可能需要等待服务器响应`);
            return null;
        }
    }
    
    // 没有找到映射
    console.error(`未找到临时ID的映射: ${tempId}`);
    return null;
}

// 从cookie中获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 从localStorage获取之前保存的会话ID
function getStoredConversationId() {
    return localStorage.getItem('currentConversationId');
}

// 保存会话ID到localStorage
function storeConversationId(id) {
    if (id) {
        localStorage.setItem('currentConversationId', id);
        console.log('会话ID已保存到localStorage:', id);
    }
}

// 初始化WebSocket连接
function initWebSocket() {
    {% if conversation %}
    conversationId = "{{ conversation.id }}";
    // 存储当前会话ID到localStorage - 确保在所有页面加载时保存
    storeConversationId(conversationId);
    console.log("已保存会话ID到localStorage:", conversationId);
    
    console.log("尝试连接WebSocket: ws://" + window.location.host + "/ws/chat/" + conversationId + "/");
    chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + conversationId + '/');

    chatSocket.onopen = function(e) {
        console.log("WebSocket连接已建立");
    };

    chatSocket.onerror = function(e) {
        console.error("WebSocket错误:", e);
        // 添加错误提示，但不显示给用户
        console.log("WebSocket连接失败，将使用HTTP API作为备用");
    };

    chatSocket.onclose = function(e) {
        console.log("WebSocket连接已关闭", e.code, e.reason);
        // 添加重连逻辑
        if (e.code !== 1000) {  // 1000是正常关闭
            console.log("WebSocket异常关闭，将在5秒后尝试重新连接");
            setTimeout(function() {
                console.log("尝试重新连接WebSocket...");
                initWebSocket();
            }, 5000);
        }
    };

    chatSocket.onmessage = function(e) {
        console.log("收到消息:", e.data);
        const data = JSON.parse(e.data);
        
        // 处理用户消息ID更新 (新增处理类型)
        if (data.type === 'user_message_id_update' && data.temp_id && data.user_message_id) {
            // 保存临时ID到实际ID的映射
            tempIdMap[data.temp_id] = data.user_message_id;
            console.log(`收到用户消息ID更新: ${data.temp_id} -> ${data.user_message_id}`);
            
            // 更新DOM中的消息ID
            const messageContainer = document.querySelector('#message-container');
            const messages = messageContainer.querySelectorAll('.alert');
            
            for (let i = 0; i < messages.length; i++) {
                const msgId = messages[i].getAttribute('data-message-id');
                if (msgId === data.temp_id) {
                    // 保留临时ID作为属性，以便后续查找
                    if (!messages[i].hasAttribute('data-temp-id')) {
                        messages[i].setAttribute('data-temp-id', data.temp_id);
                    }
                    messages[i].setAttribute('data-message-id', data.user_message_id);
                    // 移除等待标记
                    messages[i].removeAttribute('data-waiting-id');
                    console.log(`已更新DOM中的用户消息ID: ${data.temp_id} -> ${data.user_message_id}`);
                    break;
                }
            }
            return;
        }
        
        // 处理流式更新
        if (data.update && data.content) {
            // 查找最后一个助手消息
            const messageContainer = document.querySelector('#message-container');
            const messages = messageContainer.querySelectorAll('.alert');
            let lastAssistantMessage = null;
            
            // 从后往前找最近的助手消息
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].classList.contains('alert-secondary')) {
                    lastAssistantMessage = messages[i];
                    break;
                }
            }
            
            if (lastAssistantMessage) {
                // 找到消息内容的p标签
                const contentP = lastAssistantMessage.querySelector('p');
                if (contentP) {
                    // 追加新内容
                    contentP.textContent += data.content;
                    lastAssistantMessage.scrollIntoView();
                }
            }
            return;
        }
        
        // 处理ID更新
        if (data.id_update && data.message_id) {
            const messageContainer = document.querySelector('#message-container');
            const messages = messageContainer.querySelectorAll('.alert');
            
            // 如果有临时ID，则更新对应的消息ID
            if (data.temp_id) {
                // 保存临时ID到实际ID的映射
                tempIdMap[data.temp_id] = data.message_id;
                console.log(`已保存临时ID映射: ${data.temp_id} -> ${data.message_id}`);
                
                for (let i = 0; i < messages.length; i++) {
                    const msgId = messages[i].getAttribute('data-message-id');
                    if (msgId === data.temp_id) {
                        // 保留临时ID作为属性，以便后续查找
                        if (!messages[i].hasAttribute('data-temp-id')) {
                            messages[i].setAttribute('data-temp-id', data.temp_id);
                        }
                        messages[i].setAttribute('data-message-id', data.message_id);
                        console.log(`已更新用户消息ID: ${data.temp_id} -> ${data.message_id}`);
                        break;
                    }
                }
            } 
            // 如果有用户消息ID，表示这是AI回复的ID更新
            else if (data.user_message_id) {
                // 找到最后一个助手消息并更新ID
                let lastAssistantMessage = null;
                // 从后往前找最近的助手消息
                for (let i = messages.length - 1; i >= 0; i--) {
                    if (messages[i].classList.contains('alert-secondary')) {
                        lastAssistantMessage = messages[i];
                        break;
                    }
                }
                
                if (lastAssistantMessage) {
                    lastAssistantMessage.setAttribute('data-message-id', data.message_id);
                    console.log(`已更新助手消息ID: temp -> ${data.message_id}`);
                }
            }
            return;
        }
        
        // 处理常规消息，但跳过用户消息（因为已经手动添加了）
        if (!data.is_user && data.message) {
            console.log("收到AI回复消息:", data);
            
            // 移除等待状态的AI回复区域
            const waitingMessage = document.getElementById('ai-response-loading');
            if (waitingMessage) {
                waitingMessage.remove();
                console.log("已移除等待状态的AI回复区域");
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'alert alert-secondary';
            messageDiv.setAttribute('data-message-id', data.message_id || '');
            // 统一使用本地时间格式
            let timestamp;
            if (data.timestamp) {
                // 如果是ISO格式的时间戳，转换为本地时间格式
                if (typeof data.timestamp === 'string' && data.timestamp.includes('T')) {
                    timestamp = new Date(data.timestamp).toLocaleTimeString();
                } else {
                    timestamp = data.timestamp;
                }
            } else {
                timestamp = new Date().toLocaleTimeString();
            }
            
            messageDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>助手</span>
                    <div>
                        <small>${timestamp}</small>
                        <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <hr>
                <p>${data.message}</p>
            `;
            document.querySelector('#message-container').appendChild(messageDiv);
            messageDiv.scrollIntoView();
        }
    };
    {% else %}
    // 如果没有有效对话，检查localStorage中是否有保存的会话ID
    const storedConversationId = getStoredConversationId();
    console.log("从localStorage检查存储的会话ID:", storedConversationId);
    
    if (storedConversationId) {
        console.log("从localStorage恢复会话ID:", storedConversationId);
        // 立即重定向到保存的会话
        window.location.href = "{% url 'chat-main' %}?conversation_id=" + storedConversationId;
        return;
    }
    
    // 没有有效会话也没有保存的会话ID，禁用发送按钮和输入框
    document.querySelector('#message-input').disabled = true;
    document.querySelector('#send-button').disabled = true;

    // 添加创建新对话的按钮事件
    document.querySelector('#new-conversation-btn').addEventListener('click', function() {
        window.location.href = "{% url 'chat-main' %}";
    });
    {% endif %}
}

// 从服务器同步会话数据
function syncConversationData(forceRefresh = false) {
    const currentConversationId = "{{ conversation.id }}" || null;
    const storedConversationId = getStoredConversationId();
    
    // 优先使用当前页面的会话ID，如果没有则使用localStorage中的
    const syncId = currentConversationId || storedConversationId;
    
    if (!syncId) {
        console.log("没有可用的会话ID，无法同步");
        return;
    }
    
    console.log("开始同步会话数据，ID:", syncId, "强制刷新:", forceRefresh);
    
    // 显示同步状态指示
    const messageContainer = document.querySelector('#message-container');
    if (!messageContainer) {
        console.error("找不到消息容器元素，无法显示同步指示器");
        return;
    }
    
    const syncIndicator = document.createElement('div');
    syncIndicator.className = 'alert alert-info';
    syncIndicator.id = 'sync-indicator';
    syncIndicator.innerHTML = `
        <div class="d-flex align-items-center">
            <span>正在同步聊天数据...</span>
            <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    messageContainer.appendChild(syncIndicator);
    console.log("已添加同步指示器");
    
    // 确保CSRF令牌可用
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        console.error("无法获取CSRF令牌，同步请求可能会失败");
    }
    
    // 发送同步请求
    fetch('/chat/api/sync_conversation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            'conversation_id': syncId
        })
    })
    .then(response => {
        console.log("收到同步响应，状态码:", response.status);
        return response.json();
    })
    .then(data => {
        // 移除同步指示器
        const indicator = document.getElementById('sync-indicator');
        if (indicator) {
            indicator.remove();
            console.log("已移除同步指示器");
        }
        
        if (data.success) {
            console.log("会话同步成功:", data);
            
            // 检查是否需要重定向到另一个会话
            const currentConversationId = "{{ conversation.id }}" || null;
            console.log("当前会话ID:", currentConversationId, "同步返回的会话ID:", data.conversation.id);
            
            if (currentConversationId != data.conversation.id) {
                console.log("重定向到同步的会话:", data.conversation.id);
                window.location.href = "{% url 'chat-main' %}?conversation_id=" + data.conversation.id;
                return;
            }
            
            // 如果已经在正确的会话中，但页面刚加载且没有消息，则渲染消息
            if (messageContainer) {
                const existingMessages = messageContainer.querySelectorAll('.alert');
                console.log("当前页面已有消息数:", existingMessages.length, "同步返回的消息数:", data.messages.length);
                
                // 如果当前页面没有消息但有同步返回的消息，或者消息数不匹配，或者强制刷新，重新渲染
                if ((existingMessages.length === 0 && data.messages.length > 0) || 
                    (existingMessages.length !== data.messages.length) || forceRefresh) {
                    console.log("渲染同步的消息");
                    
                    // 清空现有消息
                    messageContainer.innerHTML = '';
                    
                    // 渲染所有消息
                    data.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = msg.is_user ? 'alert alert-primary' : 'alert alert-secondary';
                        messageDiv.setAttribute('data-message-id', msg.id);
                        
                        // 检查是否有对应的临时ID需要更新
                        for (const tempId in tempIdMap) {
                            if (tempIdMap[tempId] === msg.id) {
                                console.log(`同步时发现临时ID映射: ${tempId} -> ${msg.id}`);
                                messageDiv.setAttribute('data-temp-id', tempId);
                                break;
                            }
                        }
                        
                        // 统一使用本地时间格式
                        let timestamp;
                        if (msg.timestamp) {
                            // 如果是ISO格式的时间戳，转换为本地时间格式
                            if (typeof msg.timestamp === 'string' && msg.timestamp.includes('T')) {
                                timestamp = new Date(msg.timestamp).toLocaleTimeString();
                            } else {
                                timestamp = msg.timestamp;
                            }
                        } else {
                            timestamp = new Date().toLocaleTimeString();
                        }
                        
                        if (msg.is_user) {
                            messageDiv.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>您</span>
                                    <div>
                                        <small>${timestamp}</small>
                                        <button class="btn btn-sm btn-outline-primary edit-message-btn ms-2" title="编辑消息">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary regenerate-btn ms-2" title="重新生成回复">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <hr>
                                <p>${msg.content}</p>
                            `;
                        } else {
                            messageDiv.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>助手</span>
                                    <div>
                                        <small>${timestamp}</small>
                                        <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <hr>
                                <p>${msg.content}</p>
                            `;
                        }
                        
                        messageContainer.appendChild(messageDiv);
                    });
                    
                    // 滚动到最新消息
                    if (messageContainer.lastElementChild) {
                        messageContainer.lastElementChild.scrollIntoView();
                    }
                    
                    console.log("消息渲染完成");
                } else {
                    console.log("当前页面消息数与同步消息数匹配，无需重新渲染");
                }
            } else {
                console.error("找不到消息容器，无法渲染消息");
            }
        } else {
            console.error("会话同步失败:", data.message);
        }
    })
    .catch(error => {
        console.error("同步请求出错:", error);
        // 移除同步指示器
        const indicator = document.getElementById('sync-indicator');
        if (indicator) {
            indicator.remove();
        }
        
        // 如果同步失败，可能是会话不存在，清除localStorage
        if (error.response && error.response.status === 404) {
            localStorage.removeItem('currentConversationId');
            console.log("会话不存在，已清除localStorage中的会话ID");
            // 重定向到创建新会话的URL
            window.location.href = "{% url 'chat-main' %}?no_new=0";
        } else {
            // 添加错误提示
            const messageContainer = document.querySelector('#message-container');
            if (messageContainer) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span>系统</span>
                        <small>${new Date().toLocaleTimeString()}</small>
                    </div>
                    <hr>
                    <p>同步聊天数据失败，请尝试刷新页面</p>
                `;
                messageContainer.appendChild(errorDiv);
                errorDiv.scrollIntoView();
            }
        }
    });
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，初始化聊天功能");
    
    // 初始化临时ID映射表
    tempIdMap = {};
    
    // 检查并更新页面上所有可能的临时ID
    setTimeout(checkForTemporaryIds, 1000);
    
    // 设置定期检查临时ID的计时器（每30秒检查一次）
    setInterval(checkForTemporaryIds, 30000);
    
    // 检查是否是从删除会话后重定向来的，如果是则清除localStorage
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('no_new') === '1') {
        localStorage.removeItem('currentConversationId');
        console.log("已清除localStorage中的会话ID");
    }
    
    // 获取会话ID信息
    const storedConversationId = getStoredConversationId();
    const currentConversationId = "{{ conversation.id }}" || null;
    
    console.log("存储的会话ID:", storedConversationId);
    console.log("当前会话ID:", currentConversationId);
    
    // 如果当前页面有会话ID，确保它被保存到localStorage
    if (currentConversationId) {
        storeConversationId(currentConversationId);
        console.log("当前页面会话ID已保存到localStorage:", currentConversationId);
    }
    // 如果当前页面没有会话ID，但localStorage中有，则重定向到存储的会话
    else if (storedConversationId) {
        console.log("当前页面没有会话ID，但localStorage中有，重定向到存储的会话:", storedConversationId);
        window.location.href = "{% url 'chat-main' %}?conversation_id=" + storedConversationId;
        return;
    }
    
    // 初始化WebSocket连接
    initWebSocket();
    
    // 如果已在正确的会话中，同步消息数据
    if (currentConversationId) {
        syncConversationData();
    }
    
    // 添加额外的点击事件委托，确保所有重新生成按钮都有效
    const messageContainer = document.querySelector('#message-container');
    if (messageContainer) {
        console.log("初始化消息容器点击事件委托");
        messageContainer.addEventListener('click', function(e) {
            // 检查是否点击了重新生成按钮或其内部的图标
            let regenerateBtn = null;
            if (e.target.closest('.regenerate-btn')) {
                regenerateBtn = e.target.closest('.regenerate-btn');
            } else if (e.target.classList.contains('bi-arrow-clockwise') && e.target.parentElement.classList.contains('regenerate-btn')) {
                regenerateBtn = e.target.parentElement;
            }
            
            if (regenerateBtn) {
                console.log("通过事件委托捕获到重新生成按钮点击");
                const messageDiv = regenerateBtn.closest('.alert');
                
                // 防止重复触发
                if (e.handled) return;
                e.handled = true;
                
                // 获取用户消息ID
                let userMessageId;
                if (messageDiv.classList.contains('alert-primary')) {
                    userMessageId = messageDiv.getAttribute('data-message-id');
                } else if (messageDiv.classList.contains('alert-secondary')) {
                    let prevMessage = messageDiv.previousElementSibling;
                    while (prevMessage && !prevMessage.classList.contains('alert-primary')) {
                        prevMessage = prevMessage.previousElementSibling;
                    }
                    if (prevMessage) {
                        userMessageId = prevMessage.getAttribute('data-message-id');
                    }
                }
                
                if (userMessageId) {
                    console.log("通过事件委托触发重新生成，用户消息ID:", userMessageId);
                    
                    // 添加视觉反馈
                    regenerateBtn.classList.add('btn-processing');
                    regenerateBtn.disabled = true;
                    regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise animate-spin"></i>';
                    
                    // 调用重新生成函数
                    regenerateResponse(userMessageId);
                    
                    // 1秒后恢复按钮状态
                    setTimeout(() => {
                        regenerateBtn.classList.remove('btn-processing');
                        regenerateBtn.disabled = false;
                        regenerateBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                    }, 1000);
                } else {
                    console.error("无法找到对应的用户消息");
                }
            }
        });
    }
});

document.querySelector('#send-button').onclick = function(e) {
    const messageInput = document.querySelector('#message-input');
    const modelSelect = document.querySelector('#model-select');
    
    if (messageInput.value.trim() !== '') {
        const message = messageInput.value;
        const modelId = modelSelect.value;
        console.log("发送消息:", message, "模型ID:", modelId);
        
        // 禁用输入框和发送按钮，防止重复发送
        messageInput.disabled = true;
        document.querySelector('#send-button').disabled = true;
        
        // 生成唯一的临时ID
        const tempId = 'temp-' + Date.now();
        
        // 先显示用户消息
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'alert alert-primary';
        userMessageDiv.setAttribute('data-message-id', tempId);
        userMessageDiv.setAttribute('data-temp-id', tempId); // 保存临时ID作为属性
        userMessageDiv.setAttribute('data-waiting-id', '1'); // 标记为等待ID更新
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        userMessageDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>您</span>
                <div>
                    <small>${timestamp}</small>
                    <button class="btn btn-sm btn-outline-primary edit-message-btn ms-2" title="编辑消息">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn ms-2" title="重新生成回复">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <hr>
            <p>${message}</p>
        `;
        document.querySelector('#message-container').appendChild(userMessageDiv);
        userMessageDiv.scrollIntoView();
        
        // 添加AI回复区域（使用加载动画而不是"正在思考中"文本）
        const aiResponseDiv = document.createElement('div');
        aiResponseDiv.className = 'alert alert-secondary';
        aiResponseDiv.id = 'ai-response-loading';
        aiResponseDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>助手</span>
                <div>
                    <small>${timestamp}</small>
                    <div class="spinner-border spinner-border-sm ms-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <hr>
        `;
        document.querySelector('#message-container').appendChild(aiResponseDiv);
        aiResponseDiv.scrollIntoView();
        
        // 检查WebSocket连接状态
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            console.log("使用WebSocket发送消息");
            
            // 发送消息到WebSocket
            chatSocket.send(JSON.stringify({
                'message': message,
                'model_id': modelId,
                'temp_id': tempId
            }));
            
            // 重置输入框并重新启用
            messageInput.value = '';
            messageInput.disabled = false;
            document.querySelector('#send-button').disabled = false;
            messageInput.focus();
        } else {
            console.log("WebSocket未连接，使用HTTP API发送消息");
            
            // 使用HTTP API发送消息
            fetch('/chat/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'message': message,
                    'model_id': modelId,
                    'conversation_id': conversationId,
                    'temp_id': tempId  // 也发送临时ID
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误 ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 更新用户消息的ID
                if (data.user_message_id) {
                    // 保存临时ID到实际ID的映射
                    tempIdMap[tempId] = data.user_message_id;
                    console.log(`已保存临时ID映射: ${tempId} -> ${data.user_message_id}`);
                    
                    // 保留临时ID作为属性，以便后续查找
                    if (!userMessageDiv.hasAttribute('data-temp-id')) {
                        userMessageDiv.setAttribute('data-temp-id', tempId);
                    }
                    userMessageDiv.setAttribute('data-message-id', data.user_message_id);
                    console.log(`已更新用户消息ID: ${tempId} -> ${data.user_message_id}`);
                }
                
                // 移除加载状态的AI回复区域
                const waitingMessage = document.getElementById('ai-response-loading');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
                
                if (data.success) {
                    // 显示AI回复
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'alert alert-secondary';
                    aiMessageDiv.setAttribute('data-message-id', data.message_id || '');
                    
                    // 统一使用本地时间格式
                    let responseTimestamp;
                    if (data.timestamp) {
                        // 如果是ISO格式的时间戳，转换为本地时间格式
                        if (typeof data.timestamp === 'string' && data.timestamp.includes('T')) {
                            responseTimestamp = new Date(data.timestamp).toLocaleTimeString();
                        } else {
                            responseTimestamp = data.timestamp;
                        }
                    } else {
                        responseTimestamp = timestamp; // 使用之前定义的时间戳
                    }
                    
                    aiMessageDiv.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>助手</span>
                            <div>
                                <small>${responseTimestamp}</small>
                                <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <hr>
                        <p>${data.message}</p>
                    `;
                    document.querySelector('#message-container').appendChild(aiMessageDiv);
                    aiMessageDiv.scrollIntoView();
                } else {
                    // 显示错误消息
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>系统</span>
                            <small>${timestamp}</small>
                        </div>
                        <hr>
                        <p>处理AI回复出错: ${data.message}</p>
                    `;
                    document.querySelector('#message-container').appendChild(errorDiv);
                    errorDiv.scrollIntoView();
                }
            })
            .catch(error => {
                console.error('发送消息出错:', error);
                
                // 移除加载状态的AI回复区域
                const waitingMessage = document.getElementById('ai-response-loading');
                if (waitingMessage) {
                    waitingMessage.remove();
                }
                
                // 显示错误消息
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span>系统</span>
                        <small>${timestamp}</small>
                    </div>
                    <hr>
                    <p>发送消息失败，请稍后再试</p>
                `;
                document.querySelector('#message-container').appendChild(errorDiv);
                errorDiv.scrollIntoView();
            })
            .finally(() => {
                // 重新启用输入框和发送按钮
                messageInput.disabled = false;
                document.querySelector('#send-button').disabled = false;
                messageInput.focus();
                
                // 重置输入框
                messageInput.value = '';
            });
        }
    }
};

// 检查并处理页面上的临时ID
function checkForTemporaryIds() {
    console.log("检查页面上的临时ID...");
    const messageContainer = document.querySelector('#message-container');
    if (!messageContainer) return;
    
    const messages = messageContainer.querySelectorAll('.alert');
    let foundTempIds = false;
    
    for (let i = 0; i < messages.length; i++) {
        const msgDiv = messages[i];
        const msgId = msgDiv.getAttribute('data-message-id');
        
        // 检查是否是临时ID
        if (msgId && msgId.startsWith('temp-')) {
            foundTempIds = true;
            console.log("发现临时ID:", msgId);
            
            // 标记为等待ID更新
            if (!msgDiv.hasAttribute('data-waiting-id')) {
                msgDiv.setAttribute('data-waiting-id', '1');
            }
        }
    }
    
    // 如果找到临时ID，尝试通过同步API获取最新消息状态
    if (foundTempIds) {
        console.log("发现临时ID，尝试同步会话数据...");
        syncConversationData();
    }
}

// 添加键盘事件监听
document.querySelector('#message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // 阻止默认的换行行为
        document.querySelector('#send-button').click();
    }
});

// 删除对话的函数
function deleteConversation(conversationId) {
    if (confirm('确定要删除这个对话吗？此操作不可恢复。')) {
        // 如果要删除的是当前存储的会话，先清除localStorage
        const storedId = getStoredConversationId();
        if (storedId == conversationId) {
            localStorage.removeItem('currentConversationId');
            console.log("已清除localStorage中的会话ID:", conversationId);
        }
        
        fetch('/chat/api/conversations/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'id': conversationId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 删除成功，刷新页面
                window.location.href = "{% url 'chat-main' %}?no_new=1";
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('删除对话出错:', error);
            alert('删除对话时出错，请稍后再试');
        });
    }
}

// 编辑对话标题
function editConversationTitle(conversationId) {
    const titleElement = document.querySelector(`.conversation-title[data-conversation-id="${conversationId}"]`);
    const currentTitle = titleElement.textContent;
    
    // 创建编辑框
    const inputElement = document.createElement('input');
    inputElement.type = 'text';
    inputElement.value = currentTitle;
    inputElement.className = 'form-control form-control-sm';
    inputElement.style.width = '100%';
    
    // 替换标题为编辑框
    titleElement.innerHTML = '';
    titleElement.appendChild(inputElement);
    
    // 聚焦并选择全部文本
    inputElement.focus();
    inputElement.select();
    
    // 处理失去焦点和按回车事件
    function saveTitle() {
        const newTitle = inputElement.value.trim();
        if (newTitle !== '' && newTitle !== currentTitle) {
            // 发送更新请求
            fetch('/chat/api/conversations/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'id': conversationId,
                    'title': newTitle
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    titleElement.textContent = newTitle;
                } else {
                    titleElement.textContent = currentTitle;
                    alert('更新标题失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('更新标题出错:', error);
                titleElement.textContent = currentTitle;
                alert('更新标题时出错，请稍后再试');
            });
        } else {
            titleElement.textContent = currentTitle;
        }
        
        // 移除事件监听
        inputElement.removeEventListener('blur', saveTitle);
        inputElement.removeEventListener('keypress', handleKeyPress);
    }
    
    function handleKeyPress(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveTitle();
        }
    }
    
    inputElement.addEventListener('blur', saveTitle);
    inputElement.addEventListener('keypress', handleKeyPress);
    
    // 阻止点击事件冒泡，避免触发对话链接
    inputElement.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
    });
}

// 添加点击事件监听
document.addEventListener('click', function(e) {
    // 删除消息按钮点击处理
    if (e.target.closest('.delete-message-btn')) {
        const messageDiv = e.target.closest('.alert');
        const messageId = messageDiv.getAttribute('data-message-id');
        
        // 检查是否为临时ID
        if (messageId && messageId.startsWith('temp-')) {
            // 如果是临时ID，直接从DOM中移除
            messageDiv.remove();
            
            // 如果是用户消息，同时删除其后的第一个AI回复
            if (messageDiv.classList.contains('alert-primary')) {
                // 查找所有消息
                const allMessages = document.querySelectorAll('#message-container .alert');
                let foundUserMessage = false;
                
                // 遍历找到临时消息后的第一个AI回复
                for (let i = 0; i < allMessages.length; i++) {
                    if (foundUserMessage && allMessages[i].classList.contains('alert-secondary')) {
                        allMessages[i].remove();
                        console.log("已删除关联的临时AI回复");
                        break;
                    }
                    
                    // 标记找到了被删除的用户消息的位置
                    if (allMessages[i] === messageDiv) {
                        foundUserMessage = true;
                    }
                }
            }
            
            console.log("已删除临时消息");
            return;
        }
        
        if (confirm('确定要删除这条消息吗？此操作不可恢复。')) {
            // 发送删除请求
            fetch('/chat/api/messages/delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'message_id': messageId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 删除成功，从DOM中移除
                    messageDiv.remove();
                    
                    // 如果删除的是用户消息，同时删除其对应的AI回复
                    if (messageDiv.classList.contains('alert-primary')) {
                        // 查找所有消息
                        const allMessages = document.querySelectorAll('#message-container .alert');
                        let foundUserMessage = false;
                        
                        // 遍历找到被删除消息后的第一个AI回复
                        for (let i = 0; i < allMessages.length; i++) {
                            if (foundUserMessage && allMessages[i].classList.contains('alert-secondary')) {
                                allMessages[i].remove();
                                console.log("已删除关联的AI回复");
                                break;
                            }
                            
                            // 标记找到了被删除的用户消息位置
                            if (allMessages[i] === messageDiv) {
                                foundUserMessage = true;
                            }
                        }
                    }
                    
                    console.log("消息已删除");
                    
                    // 同步会话数据，确保所有客户端都更新，强制刷新
                    setTimeout(function() {
                        syncConversationData(true);
                    }, 500);
                } else {
                    alert('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('删除消息出错:', error);
                alert('删除消息时出错，请稍后再试');
            });
        }
    }
    
    // 编辑消息按钮点击处理
    if (e.target.closest('.edit-message-btn')) {
        const messageDiv = e.target.closest('.alert');
        const messageId = messageDiv.getAttribute('data-message-id');
        const messageContent = messageDiv.querySelector('p').textContent;
        
        // 将消息内容替换为编辑框
        const originalContent = messageDiv.innerHTML;
        messageDiv.innerHTML = `
            <div class="mb-2">
                <textarea class="form-control edit-textarea" rows="3">${messageContent}</textarea>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-secondary cancel-edit-btn me-2">取消</button>
                <button class="btn btn-sm btn-primary save-edit-btn" data-message-id="${messageId}">保存</button>
            </div>
        `;
        
        // 保存原始内容，以便取消时恢复
        messageDiv.setAttribute('data-original-content', originalContent);
        
        // 聚焦到文本框
        messageDiv.querySelector('.edit-textarea').focus();
    }
    
    // 取消编辑
    if (e.target.closest('.cancel-edit-btn')) {
        const messageDiv = e.target.closest('.alert');
        const originalContent = messageDiv.getAttribute('data-original-content');
        messageDiv.innerHTML = originalContent;
    }
    
    // 保存编辑
    if (e.target.closest('.save-edit-btn')) {
        const messageDiv = e.target.closest('.alert');
        const messageId = e.target.getAttribute('data-message-id');
        const newContent = messageDiv.querySelector('.edit-textarea').value;
        
        // 检查是否为临时ID
        if (messageId && messageId.startsWith('temp-')) {
            // 使用辅助函数获取真实ID
            const realId = getRealMessageId(messageId);
            if (realId) {
                console.log(`成功解析临时ID: ${messageId} -> ${realId}`);
                messageId = realId;
            } else {
                // 如果没有映射，先恢复原始内容，然后更新文本
                const originalContent = messageDiv.getAttribute('data-original-content');
                messageDiv.innerHTML = originalContent;
                messageDiv.querySelector('p').textContent = newContent;
                console.log("已更新临时消息内容，但不会触发重新生成");
                return;
            }
        }
        
        // 发送更新请求
        fetch('/chat/api/messages/edit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'message_id': messageId,
                'content': newContent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新消息内容
                const originalContent = messageDiv.getAttribute('data-original-content');
                messageDiv.innerHTML = originalContent;
                messageDiv.querySelector('p').textContent = newContent;
                
                // 如果是用户消息，自动重新生成AI回复
                if (messageDiv.classList.contains('alert-primary')) {
                    // 找到下一个AI回复消息
                    let nextMessage = messageDiv.nextElementSibling;
                    if (nextMessage && nextMessage.classList.contains('alert-secondary')) {
                        // 触发重新生成
                        regenerateResponse(messageId);
                    }
                }
            } else {
                alert('更新消息失败: ' + data.message);
                // 恢复原始内容
                const originalContent = messageDiv.getAttribute('data-original-content');
                messageDiv.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('更新消息出错:', error);
            alert('更新消息时出错，请稍后再试');
            // 恢复原始内容
            const originalContent = messageDiv.getAttribute('data-original-content');
            messageDiv.innerHTML = originalContent;
        });
    }
});

// 重新生成AI回复
function regenerateResponse(userMessageId) {
    console.log("开始重新生成回复, 用户消息ID:", userMessageId);
    const modelId = document.querySelector('#model-select').value;
    console.log("使用的模型ID:", modelId);
    
    // 使用辅助函数获取真实ID
    const realId = getRealMessageId(userMessageId);
    if (userMessageId.startsWith('temp-')) {
        if (realId) {
            console.log(`成功解析临时ID: ${userMessageId} -> ${realId}`);
            userMessageId = realId;
        } else {
            console.log("临时ID没有找到映射，尝试同步会话数据...");
            // 尝试同步会话数据以获取最新ID
            syncConversationData();
            
            // 延迟500ms后再次尝试获取真实ID
            setTimeout(() => {
                const newRealId = getRealMessageId(userMessageId);
                if (newRealId) {
                    console.log(`同步后成功解析临时ID: ${userMessageId} -> ${newRealId}`);
                    regenerateResponse(newRealId);
                } else {
                    console.error("同步后仍无法解析临时ID:", userMessageId);
                    alert('无法重新生成临时消息的回复，请等待消息保存后再试。请刷新页面后重试。');
                }
            }, 500);
            return;
        }
    }
    
    // 显示加载状态
    const messageContainer = document.querySelector('#message-container');
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'alert alert-secondary';
    loadingDiv.id = 'ai-response-loading';
    const now = new Date();
    const timestamp = now.toLocaleTimeString();
    loadingDiv.innerHTML = `
        <div class="d-flex justify-content-between">
            <span>助手</span>
            <div>
                <small>${timestamp}</small>
                <div class="spinner-border spinner-border-sm ms-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        <hr>
    `;
    messageContainer.appendChild(loadingDiv);
    loadingDiv.scrollIntoView();
    
    // 删除该用户消息后的所有AI助手消息
    const messages = messageContainer.querySelectorAll('.alert');
    let foundUserMessage = false;
    let messagesToRemove = [];
    
    console.log("查找并标记需要删除的消息...");
    for (let i = 0; i < messages.length; i++) {
        const msgDiv = messages[i];
        const msgId = msgDiv.getAttribute('data-message-id');
        
        // 如果找到了用户消息
        if (msgId === userMessageId) {
            console.log("找到用户消息:", msgId);
            foundUserMessage = true;
            continue;
        }
        
        // 如果已找到用户消息，并且当前是助手消息，标记为删除
        if (foundUserMessage && msgDiv.classList.contains('alert-secondary')) {
            console.log("标记需要删除的助手消息:", msgId || "无ID");
            messagesToRemove.push(msgDiv);
        }
    }
    
    // 删除标记的消息
    console.log("删除标记的消息，数量:", messagesToRemove.length);
    messagesToRemove.forEach(msg => {
        if (msg.id !== 'ai-response-loading') {
            msg.remove();
        }
    });
    
    // 准备请求数据
    const requestData = {
        'message_id': userMessageId,
        'model_id': modelId
    };
    console.log("发送重新生成请求:", JSON.stringify(requestData));
    
    // 发送重新生成请求
    fetch('/chat/api/messages/regenerate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log("收到响应状态:", response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error("HTTP错误响应内容:", text);
                throw new Error(`HTTP错误 ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log("解析响应数据:", data);
        // 移除加载提示
        const loadingMessage = document.getElementById('ai-response-loading');
        if (loadingMessage) {
            loadingMessage.remove();
        }
        
        if (data.success) {
            console.log("重新生成成功, 新消息ID:", data.message_id);
            // 添加新的AI回复
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'alert alert-secondary mb-3';
            aiMessageDiv.setAttribute('data-message-id', data.message_id);
            
            // 统一使用本地时间格式
            let responseTimestamp;
            if (data.timestamp) {
                // 如果是ISO格式的时间戳，转换为本地时间格式
                if (typeof data.timestamp === 'string' && data.timestamp.includes('T')) {
                    responseTimestamp = new Date(data.timestamp).toLocaleTimeString();
                } else {
                    responseTimestamp = data.timestamp;
                }
            } else {
                responseTimestamp = new Date().toLocaleTimeString();
            }
            
            aiMessageDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>助手</span>
                    <div>
                        <small>${responseTimestamp}</small>
                        <button class="btn btn-sm btn-outline-danger delete-message-btn ms-2" title="删除消息">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <hr>
                <p>${data.content}</p>
            `;
            messageContainer.appendChild(aiMessageDiv);
            aiMessageDiv.scrollIntoView();
        } else {
            console.error("重新生成失败:", data.message);
            // 显示错误消息
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>系统</span>
                    <small>${new Date().toLocaleTimeString()}</small>
                </div>
                <hr>
                <p>重新生成回复失败: ${data.message}</p>
            `;
            messageContainer.appendChild(errorDiv);
            errorDiv.scrollIntoView();
        }
    })
    .catch(error => {
        console.error('重新生成回复出错:', error);
        
        // 移除加载提示
        const loadingMessage = document.getElementById('ai-response-loading');
        if (loadingMessage) {
            loadingMessage.remove();
        }
        
        // 显示错误消息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <span>系统</span>
                <small>${new Date().toLocaleTimeString()}</small>
            </div>
            <hr>
            <p>重新生成回复时出错: ${error.message}</p>
        `;
        messageContainer.appendChild(errorDiv);
        errorDiv.scrollIntoView();
    });
}
</script>
{% endblock %}

